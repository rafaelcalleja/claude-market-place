# Python Microservice with Docker and Kubernetes Deployment
# This configuration demonstrates a complete CI/CD pipeline for:
# - Python application with pytest testing
# - Security scanning with Bandit and Trivy
# - Docker image building with Kaniko
# - Kubernetes deployment using Helm
# - SonarQube code analysis

include:
  # Python build template
  - component: $CI_SERVER_FQDN/to-be-continuous/python/gitlab-ci-python@7
    inputs:
      image: "python:3.12-slim"
      build-system: "poetry"
      pytest-args: "--cov=src --cov-report=xml --cov-report=html"
      bandit-args: "-r src/"
      mypy-files: "src/"
      ruff-args: "src/"

  # SonarQube analysis
  - component: $CI_SERVER_FQDN/to-be-continuous/sonar/gitlab-ci-sonar@4
    inputs:
      host-url: "https://sonarqube.example.com"
      project-key: "my-python-service"
      quality-gate-enabled: true

  # Docker packaging with Kaniko
  - component: $CI_SERVER_FQDN/to-be-continuous/docker/gitlab-ci-docker@6
    inputs:
      build-tool: "kaniko"
      file: "Dockerfile"
      snapshot-image: "$CI_REGISTRY_IMAGE:$CI_COMMIT_SHA"
      release-image: "$CI_REGISTRY_IMAGE:$CI_COMMIT_TAG"
      trivy-args: "--severity CRITICAL,HIGH"
      hadolint-args: "--ignore DL3008"

  # Helm deployment to Kubernetes
  - component: $CI_SERVER_FQDN/to-be-continuous/helm/gitlab-ci-helm@5
    inputs:
      chart-dir: "charts/my-service"
      common-values: "charts/my-service/values.yaml"
      review-namespace: "review-$CI_COMMIT_REF_SLUG"
      review-autostop-duration: "4 hours"
      integ-namespace: "integration"
      staging-namespace: "staging"
      prod-namespace: "production"
      prod-deploy-strategy: "manual"

  # Semantic release for versioning
  - component: $CI_SERVER_FQDN/to-be-continuous/semantic-release/gitlab-ci-semrel@3
    inputs:
      changelog-enabled: true
      auto-release-enabled: true

# Secret variables - define in GitLab CI/CD settings
# SONAR_TOKEN: SonarQube authentication token
# DOCKER_REGISTRY_PASSWORD: Container registry password
# K8S_TOKEN: Kubernetes service account token

variables:
  # Python configuration
  PYTHON_PROJECT_DIR: "."

  # Helm values per environment
  HELM_REVIEW_VALUES_FILE: "charts/my-service/values-review.yaml"
  HELM_INTEG_VALUES_FILE: "charts/my-service/values-integration.yaml"
  HELM_STAGING_VALUES_FILE: "charts/my-service/values-staging.yaml"
  HELM_PROD_VALUES_FILE: "charts/my-service/values-production.yaml"
