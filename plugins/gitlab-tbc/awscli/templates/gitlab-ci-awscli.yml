# Component: awscli
# Version: 1.0.0
# Description: AWS CLI component for executing AWS operations with role assumption support
# Documentation: https://to-be-continuous.gitlab.io/doc/ref/awscli

spec:
  inputs:
    # Docker image configuration
    cli-image:
      description: "Docker image containing AWS CLI"
      type: string
      default: "amazon/aws-cli:latest"

    # AWS region configuration
    aws-region:
      description: "AWS region for operations"
      type: string
      default: "us-east-1"

    # Role assumption configuration
    role-arn:
      description: "IAM role ARN to assume for operations (optional)"
      type: string
      default: ""

    role-session-name:
      description: "Session name when assuming role"
      type: string
      default: "gitlab-ci-${CI_PROJECT_NAME}-${CI_PIPELINE_ID}"

    role-duration:
      description: "Duration in seconds for assumed role credentials (900-43200)"
      type: number
      default: 3600

    # Script execution configuration
    script-file:
      description: "Path to AWS CLI script to execute (relative to repository root)"
      type: string
      default: ""

    script-inline:
      description: "Inline AWS CLI commands to execute (alternative to script-file)"
      type: string
      default: ""

    # Output configuration
    export-outputs:
      description: "Export AWS outputs to dotenv artifact for downstream jobs"
      type: boolean
      default: true

    # Advanced configuration
    debug-mode:
      description: "Enable AWS CLI debug output"
      type: boolean
      default: false

    install-extras:
      description: "Space-separated list of additional tools to install (e.g., 'jq yq')"
      type: string
      default: ""

# Reusable script library
.awscli-scripts: &awscli-scripts
  - |
    # Logging functions with ANSI colors
    log_info() { echo -e "\033[1;34m[INFO]\033[0m $*"; }
    log_warn() { echo -e "\033[1;33m[WARN]\033[0m $*"; }
    log_error() { echo -e "\033[1;31m[ERROR]\033[0m $*"; }
    log_success() { echo -e "\033[1;32m[SUCCESS]\033[0m $*"; }

    # Detect package manager for multi-distro compatibility
    detect_package_manager() {
      if command -v apt-get &> /dev/null; then
        echo "apt-get"
      elif command -v yum &> /dev/null; then
        echo "yum"
      elif command -v apk &> /dev/null; then
        echo "apk"
      else
        log_error "No supported package manager found"
        return 1
      fi
    }

    # Install additional tools if requested
    install_extras() {
      if [[ -n "$AWSCLI_INSTALL_EXTRAS" ]]; then
        log_info "Installing additional tools: $AWSCLI_INSTALL_EXTRAS"
        local pkg_mgr=$(detect_package_manager)

        case $pkg_mgr in
          apt-get)
            apt-get update -qq
            apt-get install -y -qq $AWSCLI_INSTALL_EXTRAS
            ;;
          yum)
            yum install -y -q $AWSCLI_INSTALL_EXTRAS
            ;;
          apk)
            apk add --no-cache $AWSCLI_INSTALL_EXTRAS
            ;;
        esac

        log_success "Additional tools installed"
      fi
    }

    # Verify AWS authentication
    verify_aws_auth() {
      log_info "Verifying AWS authentication..."

      if ! aws sts get-caller-identity &> /dev/null; then
        log_error "AWS authentication failed"
        log_error "Please ensure AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY are set"
        return 1
      fi

      local identity=$(aws sts get-caller-identity --output json)
      local account=$(echo "$identity" | grep -o '"Account": "[^"]*' | cut -d'"' -f4)
      local arn=$(echo "$identity" | grep -o '"Arn": "[^"]*' | cut -d'"' -f4)

      log_success "Authenticated as: $arn"
      log_info "AWS Account: $account"

      return 0
    }

    # Assume IAM role if role ARN is provided
    assume_role() {
      if [[ -z "$AWSCLI_ROLE_ARN" ]]; then
        log_info "No role assumption required"
        return 0
      fi

      log_info "Assuming role: $AWSCLI_ROLE_ARN"
      log_info "Session name: $AWSCLI_ROLE_SESSION_NAME"
      log_info "Duration: $AWSCLI_ROLE_DURATION seconds"

      local assume_output
      assume_output=$(aws sts assume-role \
        --role-arn "$AWSCLI_ROLE_ARN" \
        --role-session-name "$AWSCLI_ROLE_SESSION_NAME" \
        --duration-seconds "$AWSCLI_ROLE_DURATION" \
        --output json 2>&1)

      if [[ $? -ne 0 ]]; then
        log_error "Failed to assume role"
        log_error "$assume_output"
        return 1
      fi

      # Extract temporary credentials
      export AWS_ACCESS_KEY_ID=$(echo "$assume_output" | grep -o '"AccessKeyId": "[^"]*' | cut -d'"' -f4)
      export AWS_SECRET_ACCESS_KEY=$(echo "$assume_output" | grep -o '"SecretAccessKey": "[^"]*' | cut -d'"' -f4)
      export AWS_SESSION_TOKEN=$(echo "$assume_output" | grep -o '"SessionToken": "[^"]*' | cut -d'"' -f4)

      # Verify assumed role
      local assumed_identity=$(aws sts get-caller-identity --output json)
      local assumed_arn=$(echo "$assumed_identity" | grep -o '"Arn": "[^"]*' | cut -d'"' -f4)

      log_success "Successfully assumed role: $assumed_arn"

      return 0
    }

    # Execute AWS CLI script
    execute_aws_script() {
      if [[ -n "$AWSCLI_SCRIPT_FILE" ]]; then
        if [[ ! -f "$AWSCLI_SCRIPT_FILE" ]]; then
          log_error "Script file not found: $AWSCLI_SCRIPT_FILE"
          return 1
        fi

        log_info "Executing script file: $AWSCLI_SCRIPT_FILE"
        chmod +x "$AWSCLI_SCRIPT_FILE"
        bash -e "$AWSCLI_SCRIPT_FILE"

      elif [[ -n "$AWSCLI_SCRIPT_INLINE" ]]; then
        log_info "Executing inline script"
        bash -e -c "$AWSCLI_SCRIPT_INLINE"

      else
        log_warn "No script specified (neither script-file nor script-inline)"
        log_info "AWS CLI is ready for manual commands"
        return 0
      fi
    }

    # Export outputs to dotenv artifact
    export_outputs() {
      if [[ "$AWSCLI_EXPORT_OUTPUTS" != "true" ]]; then
        return 0
      fi

      log_info "Exporting outputs to awscli.env"

      {
        echo "# AWS CLI Component Outputs"
        echo "awscli_region=${AWS_DEFAULT_REGION}"
        echo "awscli_executed_at=$(date -u +%Y-%m-%dT%H:%M:%SZ)"

        if [[ -n "$AWSCLI_ROLE_ARN" ]]; then
          echo "awscli_assumed_role=${AWSCLI_ROLE_ARN}"
        fi

        # Allow user scripts to add custom outputs by writing to awscli-custom.env
        if [[ -f "awscli-custom.env" ]]; then
          log_info "Appending custom outputs from awscli-custom.env"
          cat awscli-custom.env
        fi
      } > awscli.env

      log_success "Outputs exported to awscli.env"
    }

# Hidden base job - extended by all component jobs
.awscli-base:
  image: $[[ inputs.cli-image ]]
  tags:
    - docker
  variables:
    # Map inputs to variables for backward compatibility and script access
    AWSCLI_REGION: $[[ inputs.aws-region ]]
    AWSCLI_ROLE_ARN: $[[ inputs.role-arn ]]
    AWSCLI_ROLE_SESSION_NAME: $[[ inputs.role-session-name ]]
    AWSCLI_ROLE_DURATION: $[[ inputs.role-duration ]]
    AWSCLI_SCRIPT_FILE: $[[ inputs.script-file ]]
    AWSCLI_SCRIPT_INLINE: $[[ inputs.script-inline ]]
    AWSCLI_EXPORT_OUTPUTS: $[[ inputs.export-outputs ]]
    AWSCLI_DEBUG_MODE: $[[ inputs.debug-mode ]]
    AWSCLI_INSTALL_EXTRAS: $[[ inputs.install-extras ]]

    # AWS CLI environment variables
    AWS_DEFAULT_REGION: $[[ inputs.aws-region ]]
    AWS_REGION: $[[ inputs.aws-region ]]

    # Enable debug mode if requested
    AWS_DEBUG: "$([[ \"$AWSCLI_DEBUG_MODE\" == \"true\" ]] && echo \"1\" || echo \"\")"
  before_script:
    - *awscli-scripts
    - install_extras
    - verify_aws_auth
    - assume_role
  rules:
    - !reference [.tbc-workflow-rules, skip-back-merge]
    - !reference [.tbc-workflow-rules, prefer-mr-pipeline]
    - !reference [.tbc-workflow-rules, extended-skip-ci]

# Main AWS CLI execution job
awscli-execute:
  stage: deploy
  extends: .awscli-base
  script:
    - execute_aws_script
    - export_outputs
  artifacts:
    reports:
      dotenv: awscli.env
    paths:
      - awscli.env
    expire_in: 1 week
    when: always
  rules:
    - when: on_success